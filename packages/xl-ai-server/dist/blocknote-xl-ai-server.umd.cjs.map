{"version":3,"file":"blocknote-xl-ai-server.umd.cjs","sources":["../../../node_modules/hono/dist/middleware/cors/index.js","../src/index.ts"],"sourcesContent":["// src/middleware/cors/index.ts\nvar cors = (options) => {\n  const defaults = {\n    origin: \"*\",\n    allowMethods: [\"GET\", \"HEAD\", \"PUT\", \"POST\", \"DELETE\", \"PATCH\"],\n    allowHeaders: [],\n    exposeHeaders: []\n  };\n  const opts = {\n    ...defaults,\n    ...options\n  };\n  const findAllowOrigin = ((optsOrigin) => {\n    if (typeof optsOrigin === \"string\") {\n      if (optsOrigin === \"*\") {\n        return () => optsOrigin;\n      } else {\n        return (origin) => optsOrigin === origin ? origin : null;\n      }\n    } else if (typeof optsOrigin === \"function\") {\n      return optsOrigin;\n    } else {\n      return (origin) => optsOrigin.includes(origin) ? origin : null;\n    }\n  })(opts.origin);\n  return async function cors2(c, next) {\n    function set(key, value) {\n      c.res.headers.set(key, value);\n    }\n    const allowOrigin = findAllowOrigin(c.req.header(\"origin\") || \"\", c);\n    if (allowOrigin) {\n      set(\"Access-Control-Allow-Origin\", allowOrigin);\n    }\n    if (opts.origin !== \"*\") {\n      const existingVary = c.req.header(\"Vary\");\n      if (existingVary) {\n        set(\"Vary\", existingVary);\n      } else {\n        set(\"Vary\", \"Origin\");\n      }\n    }\n    if (opts.credentials) {\n      set(\"Access-Control-Allow-Credentials\", \"true\");\n    }\n    if (opts.exposeHeaders?.length) {\n      set(\"Access-Control-Expose-Headers\", opts.exposeHeaders.join(\",\"));\n    }\n    if (c.req.method === \"OPTIONS\") {\n      if (opts.maxAge != null) {\n        set(\"Access-Control-Max-Age\", opts.maxAge.toString());\n      }\n      if (opts.allowMethods?.length) {\n        set(\"Access-Control-Allow-Methods\", opts.allowMethods.join(\",\"));\n      }\n      let headers = opts.allowHeaders;\n      if (!headers?.length) {\n        const requestHeaders = c.req.header(\"Access-Control-Request-Headers\");\n        if (requestHeaders) {\n          headers = requestHeaders.split(/\\s*,\\s*/);\n        }\n      }\n      if (headers?.length) {\n        set(\"Access-Control-Allow-Headers\", headers.join(\",\"));\n        c.res.headers.append(\"Vary\", \"Access-Control-Request-Headers\");\n      }\n      c.res.headers.delete(\"Content-Length\");\n      c.res.headers.delete(\"Content-Type\");\n      return new Response(null, {\n        headers: c.res.headers,\n        status: 204,\n        statusText: c.res.statusText\n      });\n    }\n    await next();\n  };\n};\nexport {\n  cors\n};\n","import { serve } from \"@hono/node-server\";\nimport { Hono } from \"hono\";\nimport { cors } from \"hono/cors\";\nimport { existsSync, readFileSync } from \"node:fs\";\nimport { createSecureServer } from \"node:http2\";\nimport { Agent, setGlobalDispatcher } from \"undici\";\n\n// make sure our fetch request uses HTTP/2\nsetGlobalDispatcher(\n  new Agent({\n    allowH2: true,\n  })\n);\n\nconst ignoreHeadersRe = /^content-(?:encoding|length|range)$/i;\n\nexport const proxyFetch: typeof fetch = async (request, options) => {\n  const req = new Request(request, options);\n  req.headers.delete(\"accept-encoding\"); // TBD: there may be cases where you want to explicitly specify\n  const res = await fetch(req);\n\n  const headers: HeadersInit = [...res.headers.entries()].filter(\n    ([k]) => !ignoreHeadersRe.test(k) && k !== \"strict-transport-security\"\n  );\n  return new Response(res.body, {\n    ...res,\n    status: res.status,\n    statusText: res.statusText,\n    headers,\n  });\n};\n\nfunction getProviderInfo(provider: string) {\n  if (provider === \"openai\") {\n    return {\n      key: process.env.OPENAI_API_KEY,\n    };\n  }\n  if (provider === \"groq\") {\n    return {\n      key: process.env.GROQ_API_KEY,\n    };\n  }\n  if (provider === \"albert-etalab\") {\n    return {\n      key: process.env.ALBERT_ETALAB_API_KEY,\n    };\n  }\n  return \"not-found\";\n}\n\nconst app = new Hono();\n\napp.use(\"/health\", async (c) => {\n  return c.json({ status: \"ok\" });\n});\n\napp.use(\"/ai\", cors(), async (c) => {\n  const url = c.req.query(\"url\");\n  if (!url) {\n    return c.json({ error: \"url parameter is required\" }, 400);\n  }\n\n  const provider = c.req.query(\"provider\");\n  if (!provider) {\n    return c.json({ error: \"provider parameter is required\" }, 400);\n  }\n\n  const providerInfo = getProviderInfo(provider);\n\n  if (providerInfo === \"not-found\" || !providerInfo.key?.length) {\n    return c.json(\n      {\n        error: `provider / key not found for provider ${provider}. Make sure to load correct env variables.`,\n      },\n      404\n    );\n  }\n\n  // eslint-disable-next-line no-console\n  console.log(\"Proxying request to\", url);\n  const request = new Request(url, c.req.raw);\n  request.headers.set(\"Authorization\", `Bearer ${providerInfo.key}`);\n  return proxyFetch(request);\n});\n\nconst http2 = existsSync(\"localhost.pem\");\nserve(\n  {\n    fetch: app.fetch,\n    createServer: http2 ? createSecureServer : undefined,\n\n    serverOptions: {\n      key: http2 ? readFileSync(\"localhost-key.pem\") : undefined,\n      cert: http2 ? readFileSync(\"localhost.pem\") : undefined,\n    },\n    port: Number(process.env.PORT) || 3000,\n  },\n  (info) => {\n    // eslint-disable-next-line no-console\n    console.log(\n      `Server is running on ${info.address}${info.port}, http2: ${http2}`\n    );\n  }\n);\n"],"names":["cors","options","opts","findAllowOrigin","optsOrigin","origin","c","next","set","key","value","allowOrigin","existingVary","_a","_b","headers","requestHeaders","undici","Agent","ignoreHeadersRe","proxyFetch","request","req","res","k","getProviderInfo","provider","app","Hono","url","providerInfo","http2","existsSync","nodeServer","createSecureServer","readFileSync","info"],"mappings":"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","x_google_ignoreList":[0]}